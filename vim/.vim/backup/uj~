#! /bin/bash

count=0
bank_time=0;
mode=$1

select_text()
{
  xdotool search --name "Play Dream World" mousemove --sync $1 $2
  xdotool search --name "Play Dream World" mousedown 1
  xdotool search --name "Play Dream World" mousemove --sync $3 $4
  xdotool search --name "Play Dream World" mouseup 1  
  sleep 0.1
  xdotool search --name "Play Dream World" click 1
}

reset_puzzlesolver()
{
  click 173 206
  click 173 206
  click 430 350
}

double_click()
{
  xdotool search --name "Play Dream World" mousemove $1 $2
  xdotool search --name "Play Dream World" click 1
  sleep 0.1
  xdotool search --name "Play Dream World" click 1
}

spell()
{
  check_mp $1
  xdotool search --name "Play Dream World" type $1

  key 's' "no_wait"
  [ "$2" == "no_wait"  ] || sleep 0.47
  sleep 0.1
  key 's' "no_wait"
}

check_mp()
{
  [ "$1" = "q" ] && level=1
  [ "$1" = "[" ] && level=45
  [ "$1" = "|" ] && level=60

  double_click 763 256
  cb=`xsel`
    #echo Fairydust: $cb $level
  if (( "$cb" < "$level" )) ; then
    use_fairydust
  fi
}

go_alien()
{
  # Town Map
  click 248 322
  sleep 3
  click 248 322

  # World Map
  click 797 356
  sleep 1

  # Junk Town Fight
  click 675 702
}

go_gate()
{
  #Town Map
  click 248 322

  # World Map
  click 797 356

  click 810 581
  [ "$1" == "fire" ] && click 223 559
  [ "$1" == "ice" ] && click 479 559
  [ "$1" == "thunder" ] && click 726 559
}

check_hp()
{
  level=11000
  
  double_click 356 274
  cb=`xsel`
  if (( "$cb" < "$level" )) ; then
    #xdotool search --name "Play Dream World" type '[' # heal
    spell '['
    echo true
  fi
  echo false
}

check_final_strike()
{
  level=1500

  double_click 603 386
  cb=`xsel`
  (( "$cb" < "$level" )) && spell '|' && echo false && return
  echo true
}

click()
{
  xdotool search --name "Play Dream World" mousemove $1 $2
  xdotool search --name "Play Dream World" click 1
  sleep 1
}

explore()
{
  xdotool search --name "Play Dream World" key  space
  sleep 0.5
}

key()
{
  if  [ "$2" == "no_wait" ] ; then
    xdotool search --name "Play Dream World" key $1
  else
    xdotool search --name "Play Dream World" key --delay 300 $1
  fi
}

bank()
{
  #if [ $bank_time -eq 10 ] ; then
    #bank_time=0
    key 'b'
    key 'c'
  #else
    #let bank_time=$(( bank_time + 1 ))
  #fi
}

take_fd_from_storage()
{
  # Bank
  click 385 351
  
  dust_number=$(check_fairydust)
  if [ "$dust_number" -gt '0' ] ; then
    x=321
    y=$(( 560 + $((--dust_number)) * 45 ))
    click $x $y
  fi
}

parse_data()
{
  select_text 102 244 857 345

   level=`xsel | awk "/Gandalf/ { print $3; }"`
  printf "$level"
exit
}


check_state()
{
  ret=0

  # Encounter
  select_text 430 350 537 400
  cb=`xsel`
  if echo $cb | grep "ncounter" ; then
    if echo $cb | egrep "Dust Merchant|Magic Elf|Girl in Red|Guardian of Dreams" ; then
      ret=1
    elif echo $cb | egrep "thief guard|ENRAGED thief shamani|Alien|ice " ; then
      ret=17
    else
      ret=16
    fi
  elif echo $cb | egrep  "The Marsh|The Sewers|The Forest|Thieves " ; then
    select_text 420 420 550 430
    cb=`xsel`
    if echo $cb | grep  "A Puzzle Box" ; then
      ret=2
    elif echo $cb | grep  "Magic Mushrooms" ; then
      ret=3
    elif echo $cb | grep  "Wishing Well" ; then
      ret=4
    elif echo $cb | grep  "The Wiseman" ; then
      ret=5
    elif echo $cb | grep  "A Treasure Map" ; then
      ret=6
    elif echo $cb | grep  "A Treasure Chest" ; then
      ret=7
    elif echo $cb | grep  "Little Imp" ; then
      ret=8
    elif echo $cb | grep  "Dust Merchant" ; then
      ret=9
    elif echo $cb | grep  "The Gambler" ; then
      ret=10
    elif echo $cb | grep  "Magic Elf" ; then
      ret=11
    elif echo $cb | grep  "A Beggar" ; then
      ret=12
    elif echo $cb | grep  "Guardian of Dream" ; then
      ret=14
    elif echo $cb | grep  "enter valid amount" ; then
      ret=15
    elif [ $cd -z ] ; then
      sleep 5
      key 'c'
      explore
    fi
  elif echo $cb | egrep  "Rat Demon|emon Captain|Demon Captain|emon Leader| Boss" ; then
    ret=17
    #ret=13
  fi

  [ "$ret" -ne 0 ] && count=0 && return $ret

  echo ERROR: Unrecognizable state: $cb
  return 0
}

handle_mushroom()
{
  # Taste
  click 716 476
  # Explore
  explore
}

handle_puzzlebox()
{
  reset_puzzlesolver
  sleep 3
  explore
}

handle_whishingwell()
{
  # High
  click 685 528
  explore
}

handle_treasuremap()
{
  # Find
  click 716 552
  explore
}

handle_treasurechest()
{
  # let greasmonkey do the work
  reset_puzzlesolver
  sleep 1
  explore
}   

handle_wiseman()
{
  # Accept
  click 713 491
  explore
}

handle_encounter()
{
  count=0
  #check_mp
  
  [ "$1" = "spell" ] && $(check_final_strike) && spell 'q' "no_wait"
  [ "$1" = "recover" ] && spell '|'
  [ "$1" = "hit" ] && key 'a' "no_wait"

  explore "no_wait"
}

handle_gambler()
{
  # Fight
  click 721 623
}

handle_magicelf()
{
  # Fight
  click 717 650
}

handle_beggar()
{
  # High
  click 680 525
  explore
}

handle_dustmerchant()
{
  # Fight
  click 717 652
}

handle_littleimp()
{
  # Accept
  click 716 534
  explore
}

handle_ratdemon()
{
  # Run Away
  click 797 400
  # Ok
  click 442 469
  explore
}

handle_validamount()
{
  # Close
  click 480 475
}

buy_fairydust()
{
  dust_to_buy=$1

  # 
  

  # Town Map
  click 248 322
  click 248 322

  # World Map
  click 797 356

  # Junktown
  click 608 657

  # Shop
  click 343 447

  while (( dust_to_buy > 0 ))
  do
    # Buy
    click 821 555
    ((dust_to_buy--)) 
  done

  # Restore full health
  click 819 664  
}

check_fairydust()
{
  sleep 0.1
  select_text 102 244 857 345
  cb=`xsel|tr -d [:cntrl:] | tr -d [:space:]`
  sleep 0.2
 regex10="StorageGun(fairydust)Use"
  regex9="StorageGun(.*)Gun(fairydust)Use"
  regex8="StorageGun(.*)Gun(.*)Gun(fairydust)Use"
  regex7="StorageGun(.*)Gun(.*)Gun(.*)Gun(fairydust)Use"
  regex6="StorageGun(.*)Gun(.*)Gun(.*)Gun(.*)Gun(fairydust)Use"
  regex5="InventoryItem(fairydust)Use"
  regex4="InventoryItem(.*)Item(fairydust)Use"
  regex3="InventoryItem(.*)Item(.*)Item(fairydust)Use"
  regex2="InventoryItem(.*)Item(.*)Item(.*)Item(fairydust)Use"
  regex1="InventoryItem(.*)Item(.*)Item(.*)Item(.*)Item(fairydust)Use"

  if [[ $cb =~ $regex1 ]] || [[ $cb =~ $regex2 ]] || [[ $cb =~ $regex3 ]] || [[ $cb =~ $regex4 ]] || [[ $cb =~ $regex5 ]] ||
   [[ $cb =~ $regex6 ]] || [[ $cb =~ $regex7 ]] || [[ $cb =~ $regex8 ]] || [[ $cb =~ $regex9 ]] || [[ $cb =~ $regex10 ]] ; then
    echo $((${#BASH_REMATCH[*]}-1))
  fi
}

use_fairydust()
{
  key 'n'
  dust_number=$(check_fairydust)
  if [ "$dust_number" -gt '0' ] ; then
    key $dust_number
    # Close
    key 'c'
    key 'c'
  elif $(take_fd_from_storage) ; then key 'c'
  else
    buy_fairydust 4
    use_fairydust

    # Buy again
    click 821 555

    # max Energy
    #click 819 520

    #go_gate "fire"

    go_alien "junktown"
  fi
}

handle_guardianofdreams()
{
  # Fight
  click 707 547
}

sleep 1
while [ -z "$mode" ]
do
  sleep 0.1

  key 'c' "no_wait"
  #bank

  #parse_data
  $(check_hp) && continue

  check_state 
  ret_val=$?
  if [ "$ret_val"  -eq '1' ]; then
    handle_encounter "hit"
  elif [ "$ret_val"  -eq '2' ]; then
    handle_puzzlebox
  elif [ "$ret_val"  -eq '3' ]; then
    handle_mushroom
  elif [ "$ret_val"  -eq '4' ]; then
    handle_whishingwell
  elif [ "$ret_val"  -eq '5' ]; then
    handle_wiseman
  elif [ "$ret_val"  -eq '6' ]; then
    handle_treasuremap
  elif [ "$ret_val"  -eq '7' ]; then
    handle_treasurechest
  elif [ "$ret_val"  -eq '8' ]; then
    handle_littleimp
  elif [ "$ret_val"  -eq '9' ]; then
    handle_dustmerchant
  elif [ "$ret_val"  -eq '10' ]; then
    handle_gambler
  elif [ "$ret_val"  -eq '11' ]; then
    handle_magicelf
  elif [ "$ret_val"  -eq '12' ]; then
    handle_beggar
  elif [ "$ret_val"  -eq '13' ]; then
    handle_ratdemon
  elif [ "$ret_val"  -eq '14' ]; then
    handle_guardianofdreams
  elif [ "$ret_val"  -eq '15' ]; then
    handle_validamount
  elif [ "$ret_val"  -eq '16' ]; then
    handle_encounter "spell"
  elif [ "$ret_val"  -eq '17' ]; then
    handle_encounter "recover"
  else
    echo ERROR: wrong state number: $ret_val
    if [ "$count" -eq '10' ]; then
      exit
    else
      ((count++))
    fi
  fi
done


while [ "$mode" = "test" ]
do
  sleep 1
  take_fd_from_storage
done

while [ "$mode" = "boss" ]
do
  sleep 0.1
  key 'space' "no_wait"

  $(check_hp) && continue
  $(check_final_strike) && spell '|'
done
